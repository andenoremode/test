<html>
  <head>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@2.9.3/dist/Chart.min.js"></script>
    <script>

var myChart = null;
var measurement_count = 0;

function log(text) {
  logger = document.querySelector('#logview');
  logger.innerHTML += text + '<br />';
  console.log(text);

}

async function onButtonClick() {
  let filters = [];

  let options = {};
  options.acceptAllAdvertisements = true;
  
  try {
    log('Requesting Bluetooth Scan with options: ' + JSON.stringify(options));
    const scan = await navigator.bluetooth.requestLEScan(options);

    log('Scan started with:');
    log(' acceptAllAdvertisements: ' + scan.acceptAllAdvertisements);
    log(' active: ' + scan.active);
    log(' keepRepeatedDevices: ' + scan.keepRepeatedDevices);
    log(' filters: ' + JSON.stringify(scan.filters));

    navigator.bluetooth.addEventListener('advertisementreceived', event => {
      //log('Advertisement received.');
      //log('  Device Name: ' + event.device.name);
      //log('  Device ID: ' + event.device.id);
      //log('  RSSI: ' + event.rssi);
      //log('  TX Power: ' + event.txPower);
      //log('  UUIDs: ' + event.uuids);
      //event.manufacturerData.forEach((valueDataView, key) => {
      //  logDataView('Manufacturer', key, valueDataView);
      //});
      //event.serviceData.forEach((valueDataView, key) => {
      //  logDataView('Service', key, valueDataView);
      //});

      let modeData = event.manufacturerData.get(0xde10);
      if (modeData.byteLength != 21) {
        // Isnâ€™t an mode device.
        return;
      }

      let seqNo = modeData.getUint8(0, true);
      //log("seqNo " + seqNo);
      let snYear = modeData.getUint8(1, true);
      //log("snYear " + snYear);
      let snMonth = modeData.getUint8(2, true);
      //log("snMonth " + snMonth);
      let snNumber = modeData.getUint32(3, true);
      //log("snNumber " + snNumber);
      let battery0 = modeData.getFloat32(7, true);
      //log("battery0 " + battery0);
      let battery1 = modeData.getFloat32(11, true);
      //log("battery1 " + battery1);
      let avgBioz = modeData.getUint16(15, true);
      //log("avgBioz " + avgBioz);
      let avgCCA = modeData.getUint16(17, true);
      //log("avgCCA " + avgCCA);
      let worstSfdr = modeData.getInt16(19, true);
      //log("worstSfdr " + worstSfdr);

      newModeDevice(seqNo, snYear, snMonth, snNumber, battery0, battery1, avgBioz, avgCCA, worstSfdr);

    });
  } catch(error)  {
    log('Argh! ' + error);
  }
}

function newModeDevice(seqNo, snYear, snMonth, snNumber, battery0, battery1, avgBioz, avgCCA, worstSfdr) {
  log("Mode device: " + (snYear + 10).toString(36) + (snMonth + 10).toString(36), snNumber.toString(36));

  addChartData(measurement_count, battery0);

  measurement_count += 1;
}

function addChartData(idx, data) {
    myChart.data.labels.push(idx);
    myChart.data.datasets.forEach((dataset) => {
        dataset.data.push(data);
    });
    myChart.update();
  }

/* Utils */
const logDataView = (labelOfDataSource, key, valueDataView) => {
  const hexString = [...new Uint8Array(valueDataView.buffer)].map(b => {
    return b.toString(16).padStart(2, '0');
  }).join(' ');
  const textDecoder = new TextDecoder('ascii');
  const asciiString = textDecoder.decode(valueDataView.buffer);
  log(`  ${labelOfDataSource} Data: ` + key +
      '\n    (Hex) ' + hexString +
      '\n    (ASCII) ' + asciiString);
};

window.onload =  function() {

  log("v4");

  document.querySelector('form').addEventListener('submit', function(event) {
        event.stopPropagation();
        event.preventDefault();
    
          onButtonClick();
      });

  await onButtonClick();


  var ctx = document.getElementById('myChart').getContext('2d');
  var idx = 0;

  myChart = new Chart(ctx, {
      type: 'line',
      data: {
          labels: [],
          datasets: [{
              label: 'Battery 1',
              data: [],
              borderWidth: 1
          }]
      },
      options: {
          maintainAspectRatio: true,
          scales: {
              yAxes: [{
                  ticks: {
                      beginAtZero: true
                  }
              }]
          }
      }
  });

};

    </script>
  </head>

  <body>
    <form>
      <!--label for="allAdvertisements">All Advertisements</label>
      <input id="allAdvertisements" type="checkbox">
      <input id="name" type="text" size=17 placeholder="Device Name">
      <input id="namePrefix" type="text" size=17 placeholder="Device Name Prefix"-->
      <button>Scan for Bluetooth Advertisements</button>
    </form>

    <canvas id="myChart" style="min-height: 250px;"></canvas>

    <div id="logview">

    </div>
      
  </body>

</html>
